---
import { actions } from "astro:actions";
import {
  AvBookmarksEmpty,
  AvBookmarksList,
  AvBreadcrumb,
  AvContainer,
  AvPageHeader,
} from "@ansiversa/components";
import AppShell from "../layouts/AppShell.astro";

const user = Astro.locals.user;
const rootAppUrl = Astro.locals.rootAppUrl ?? "https://ansiversa.com";

if (!user) {
  const loginUrl = new URL("/login", rootAppUrl);
  loginUrl.searchParams.set("returnTo", Astro.url.toString());
  return Astro.redirect(loginUrl.toString());
}

const listResult = await Astro.callAction(actions.exampleItems.listItemBookmarks, {});
const bookmarkData = (listResult as any)?.data ?? listResult ?? {};
const items = Array.isArray(bookmarkData?.items) ? bookmarkData.items : [];

const bookmarkListItems = items.map((item: any) => ({
  title: item.title || item.label || "Untitled item",
  subtitle: item.updatedAt
    ? `Updated ${new Date(item.updatedAt).toLocaleDateString()}`
    : "Update date unavailable",
  href: item.href || `/items/${item.itemId}`,
  rightSlot: {
    active: true,
    activeExpr: "true",
    title: "Save bookmark",
    activeTitle: "Remove bookmark",
    size: "sm" as const,
    onClick: `toggleBookmarkItem('${String(item.itemId).replace(/'/g, "\\'")}', ${JSON.stringify(item.title || item.label || "Untitled item")})`,
  },
}));

const title = "Bookmarks - App Starter";
const description = "Saved in App Starter";
---

<AppShell title={title} description={description}>
  <section class="av-faq-public__crumb">
    <AvContainer size="default">
      <AvBreadcrumb
        items={[
          { label: "Home", href: "/" },
          { label: "Bookmarks" },
        ]}
      />
    </AvContainer>
  </section>

  <AvPageHeader title="Bookmarks" description="Saved in App Starter" />

  <section class="av-section">
    <AvContainer>
      <div
        x-data="{
          busy: false,
          async toggleBookmarkItem(itemId, label) {
            if (this.busy) return;
            this.busy = true;
            try {
              await $store.exampleItems.toggleBookmarkItem({ id: String(itemId), title: label || '' });
              window.location.reload();
            } catch (err) {
              console.error(err);
            } finally {
              this.busy = false;
            }
          }
        }"
      >
        {items.length === 0 ? <AvBookmarksEmpty /> : <AvBookmarksList items={bookmarkListItems} />}
      </div>
    </AvContainer>
  </section>
</AppShell>
